<!DOCTYPE html>
<html lang="en">

<head>
    <style type="text/css">
        @font-face {
            font-family: gotham;
            src: url(/gotham-book-regular.otf);
        }

        * {
            font-family: Helvetica Neue;
        }

        a:link,
        a:visited {
            color: #5e3f99;
        }

        input[type=text]:focus {
            border-color: #f68826;
            box-shadow: 0 0 5px #f68826 !important;
        }

        input[type=email]:focus {
            border-color: #f68826;
            box-shadow: 0 0 5px #f68826 !important;
        }

        span {
            color: white !important;
            fill: white !important;
        }

        .sv-root-modern .sv-container-modern {
            color: white !important;
            fill: white !important;
        }
        .sv-radio__svg {
            border-color: white !important;
        }

        .sv-root-modern .sv-radio--checked .sv-radio__svg  {
            fill: white !important;
        }

        .sv-root-modern input.sv-text, textarea.sv-comment, select.sv-dropdown{
            color: white !important;
        }
        
    </style>
    <title>Surveys</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

    <!-- Latest compiled and minified CSS -->
    <!-- Using Bootsawtch theme: https://bootswatch.com/cyborg/ -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">


    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <link href="https://unpkg.com/survey-knockout@1.8.41/modern.css" type="text/css" rel="stylesheet"/>
    <script src="https://unpkg.com/jquery"></script>
    <script src="https://unpkg.com/survey-jquery@1.8.41/survey.jquery.min.js"></script>

    <script type="text/javascript" src='/js/StimToolLib.js'></script>

</head>

<body>

    <div class="container" style="max-width: 800px;">
        <div class="py-5 text-center">
            <img class="d-block mx-auto mb-4" src="/images/logo_reversed.jpg" alt="" width="180" height="50">
            <!-- <h4>Cultural Survey</h4> -->
          </div>
    </div>

    <div class="container" style="max-width: 800px;">
        <div class="row" >
            <div id="surveyElement" style="max-width: 800px; width: 770px; margin-bottom:40px"></div>
            
            <div id="surveyResult"></div>
        </div>
    </div>

    <div class="jumbotron container" style="margin-bottom:0;max-width: 400px;">
        <table class="table table-hover">
            <tbody>
                <tr>
                  <th scope="row">ID:</th>
                  <td><a id="participant"></a></td>
                </tr>
                <tr>
                    <th scope="row">Session:</th>
                    <td><a id="session"></a></td>
                  </tr>
                  <tr>
                    <th scope="row">Study:</th>
                    <td><a id="study"></a></td>
                  </tr>
              </tbody>
        </table>
        <p style="text-align: center;">&copy; 2021 <a href="http://www.laureateinstitute.org">laureateinstitute.org</a>. All rights reserved.</p>
    </div>

    <script type="text/javascript">

        Survey
            .StylesManager
            .applyTheme("modern");
        // Survey.Survey.cssType = "bootstrap";
        // Survey.defaultBootstrapCss.navigationButton = "btn";
        var json = {
             "title": "WHODAS",
             "description": "This questionnaire asks about difficulties due to health conditions. Health conditions include diseases or illnesses, other health problems that may be short or long lasting, injuries, mental or emotional problems, and problems with alcohol or drugs. Think back over the past 30 days and answer these questions, thinking about how much difficulty you had doing the following activities. For each question, please select only one response.",
             "logoPosition": "right",
             "pages": [
              {
               "name": "page1",
               "elements": [
                {
                 "type": "radiogroup",
                 "name": "question1",
                 "title": "Standing for long periods such as 30 minutes?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question2",
                 "title": "Taking care of your household responsibilities?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question3",
                 "title": "Learning a new task, for example, learning how to get to a new place?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question4",
                 "title": "How much of a problem did you have joining in community activities (for example, festivities, religious or other activities) in the same way as anyone else can?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question5",
                 "title": "How much have you been emotionally affected by your health problems?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question6",
                 "title": "Concentrating on doing something for ten minutes?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question7",
                 "title": "Walking a long distance such as a kilometer (or equivalent)?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question8",
                 "title": "Washing your whole body?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question9",
                 "title": "Getting dressed?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question10",
                 "title": "Dealing with people you do not know?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question11",
                 "title": "Maintaining a friendship?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question12",
                 "title": "Your day-to-day work?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None"
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild"
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate"
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe"
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme or cannot do"
                  }
                 ]
                },
                {
                 "type": "dropdown",
                 "name": "question13",
                 "title": "Overall, in the past 30 days, how many days were these difficulties present?",
                 "isRequired": true,
                 "choices": [
                  "0",
                  "1",
                  "2",
                  "3",
                  "4",
                  "5",
                  "6",
                  "7",
                  "8",
                  "9",
                  "10",
                  "11",
                  "12",
                  "13",
                  "14",
                  "15",
                  "16",
                  "17",
                  "18",
                  "19",
                  "20",
                  "21",
                  "22",
                  "23",
                  "24",
                  "25",
                  "26",
                  "27",
                  "28",
                  "29",
                  "30"
                 ]
                },
                {
                 "type": "dropdown",
                 "name": "question14",
                 "title": "In the past 30 days, for how many days were you totally unable to carry out your usual activities or work because of any health condition?",
                 "isRequired": true,
                 "choices": [
                  "0", 
                  "1",
                  "2",
                  "3",
                  "4",
                  "5",
                  "6",
                  "7",
                  "8",
                  "9",
                  "10",
                  "11",
                  "12",
                  "13",
                  "14",
                  "15",
                  "16",
                  "17",
                  "18",
                  "19",
                  "20",
                  "21",
                  "22",
                  "23",
                  "24",
                  "25",
                  "26",
                  "27",
                  "28",
                  "29",
                  "30"
                 ]
                },
                {
                 "type": "dropdown",
                 "name": "question15",
                 "title": "In the past 30 days, not counting the days that you were totally unable, for how many days did you cut back or reduce your usual activities or work because of any health condition?",
                 "isRequired": true,
                 "choices": [
                  "0", 
                  "1",
                  "2",
                  "3",
                  "4",
                  "5",
                  "6",
                  "7",
                  "8",
                  "9",
                  "10",
                  "11",
                  "12",
                  "13",
                  "14",
                  "15",
                  "16",
                  "17",
                  "18",
                  "19",
                  "20",
                  "21",
                  "22",
                  "23",
                  "24",
                  "25",
                  "26",
                  "27",
                  "28",
                  "29",
                  "30"
                 ]
                }
               ]
              }
             ]
            }

        window.survey = new Survey.Model(json);


        // Recor the response time or how long they spent on a page
        lastpage = survey.currentPage;
        function timerLoop(elapsed) {
            var page = survey.currentPage; // page variable is the currentPage on the survey
            if (!page) return;
            if (lastpage != page) {
                // set new start date
                start = new Date().getTime(); // sets new start Date object when page has changed.
                lastpage = page // sets the last page to currente page 

            }
            var valueName = "TRQ" + survey.pages.indexOf(page);

            var ms = survey.getValue(valueName); // gets the value of the valuename. e.g: TRQ1

            if (ms == null) ms = 0;
            else ms = elapsed;
            survey.setValue(valueName, ms);
            $('#timeEl').text(elapsed + ' ms');
        }


        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return 'NULL'
        }

        survey.showProgressBar = "bottom";

        survey.goNextPageAutomatic = false
        survey.showNavigationButtons = true;
        survey.showCompletedPage = false;

        // Get Query Variables
        var surveyname = getQueryVariable('survey');

        var expInfo = { 'participant': '' ,'session': '',  'task': surveyname, 'date' : formatDate(), 'study': '', 'id': getQueryVariable('id') };

        // Get info Promize
        const getInfoPromise = new Promise((resolve, reject) => {
            $.ajax({
                type: "POST",
                url: '/getInfo',
                data: { 'id': expInfo.id },
                dataType: 'JSON',
                success: function (data) {
                    resolve(data)
                }
            })
        })
            // Read getINFO 
            .then((values) => {
                console.log(values)
                if (values.subject && values.session && values.study) {
                    expInfo.participant = values.subject
                    expInfo.study = values.study
                    expInfo.session = values.session
                    expInfo.run_id = getQueryVariable('run')
                }

                survey.onComplete.add(function (result) {
                    //result.preventDefault();
                    postSurveyData(result.data, expInfo.session, expInfo.participant);
                });

                $("#surveyElement").Survey({model: survey});
    
                $("#participant").text(expInfo.participant);
                $("#session").text(expInfo.session);
                $("#study").text(expInfo.study);

            })

        function postSurveyData(data, session, mkturkid) {
            console.log('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
            $.ajax({
                type: "POST",
                url: '/save',
                data: {
                    "trials_data": data,
                    "expInfo": expInfo
                },
                dataType: 'JSON',
                statusCode: {
                    200: function() {
                        console.log('sucess saved on backend')
                        console.log('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
                        window.location.replace('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
                    }
                }
            }) 
                
        }

        var start = new Date().getTime(),
            elapsed = '0.0';

        // executes timerCallback every 100 ms
        timerID = window.setInterval(function () {

            var time = new Date().getTime() - start;
            elapsed = Math.floor(time);

            //alert(elapsed);
            //$('#timeEl').text(elapsed + ' ms');

            //displayTime(1);
            timerLoop(elapsed);

        }, 5);
    </script>

</body>

</html>
