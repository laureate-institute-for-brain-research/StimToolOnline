<!DOCTYPE html>
<html lang="en">

<head>
    <style type="text/css">
        @font-face {
            font-family: gotham;
            src: url(/gotham-book-regular.otf);
        }

        * {
            font-family: Helvetica Neue;
        }

        a:link,
        a:visited {
            color: #5e3f99;
        }

        input[type=text]:focus {
            border-color: #f68826;
            box-shadow: 0 0 5px #f68826 !important;
        }

        input[type=email]:focus {
            border-color: #f68826;
            box-shadow: 0 0 5px #f68826 !important;
        }

        span {
            color: #969696!important;
            fill: #969696!important;
        }

        .sv-root-modern .sv-container-modern {
            color:#969696!important;
            fill:#969696!important;
        }
        .sv-radio__svg {
            border-color: #969696!important;
        }

        .sv-root-modern .sv-radio--checked .sv-radio__svg  {
            fill: #969696!important;
        }

        .sv-root-modern input.sv-text, textarea.sv-comment, select.sv-dropdown{
            color: #969696!important;
        }

        input[type=button] {
            color: black !important;
        }
        
    </style>
    <title>Surveys</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

    <!-- Latest compiled and minified CSS -->
    <!-- Using Bootsawtch theme: https://bootswatch.com/cyborg/ -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">


    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <link href="https://unpkg.com/survey-knockout@1.8.41/modern.css" type="text/css" rel="stylesheet"/>
    <script src="https://unpkg.com/jquery"></script>
    <script src="https://unpkg.com/survey-jquery@1.8.41/survey.jquery.min.js"></script>

    <script type="text/javascript" src='/js/StimToolLib.js'></script>

</head>

<body>

    <div class="container" style="max-width: 800px;">
        <div class="py-5 text-center">
            <img class="d-block mx-auto mb-4" src="/images/logo_reversed.jpg" alt="" width="180" height="50">
            <!-- <h4>Cultural Survey</h4> -->
          </div>
    </div>

    <div class="container" style="max-width: 800px;">
        <div class="row" >
            <div id="surveyElement" style="max-width: 800px; width: 770px; margin-bottom:40px"></div>
            
            <div id="surveyResult"></div>
        </div>
    </div>

    <div class="jumbotron container" style="margin-bottom:0;max-width: 400px;">
        <table class="table table-hover">
            <tbody>
                <tr>
                  <th scope="row">ID:</th>
                  <td><a id="participant"></a></td>
                </tr>
                <tr>
                    <th scope="row">Session:</th>
                    <td><a id="session"></a></td>
                  </tr>
                  <tr>
                    <th scope="row">Study:</th>
                    <td><a id="study"></a></td>
                  </tr>
              </tbody>
        </table>
        <p style="text-align: center;">&copy; 2021 <a href="http://www.laureateinstitute.org">laureateinstitute.org</a>. All rights reserved.</p>
    </div>

    <script type="text/javascript">

        Survey
            .StylesManager
            .applyTheme("modern");
        // Survey.Survey.cssType = "bootstrap";
        // Survey.defaultBootstrapCss.navigationButton = "btn";
        var json = {
             "title": "Beck Depression Inventory",
             "description": "This questionnaire consists of 20 groups of statements. Please read each group of statements carefully, and then pick out the one statement in each group that best describes the way you have been feeling during the past two weeks, including today. If several statements in the group seem to apply equally well, select the highest number for that group. Be sure that you do not choose more than one statement for any group, including (Changes in Sleeping Pattern) or (Changes in Appetite).",
             "logoPosition": "right",
             "pages": [
              {
               "name": "page1",
               "elements": [
                {
                 "type": "radiogroup",
                 "name": "question1",
                 "title": "Sadness",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I do not feel sad."
                  },
                  {
                   "value": "Item 2",
                   "text": "I feel sad much of the time."
                  },
                  {
                   "value": "Item 3",
                   "text": "I am sad all the time."
                  },
                  {
                   "value": "Item 4",
                   "text": "I am so sad or unhappy that I can't stand it."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question2",
                 "title": "Pessimism",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I am not discouraged about my future."
                  },
                  {
                   "value": "Item 2",
                   "text": "I feel more discouraged about my future than I used to be."
                  },
                  {
                   "value": "Item 3",
                   "text": "I do not expect things to work out for me."
                  },
                  {
                   "value": "Item 4",
                   "text": "I feel my future is hopeless and will only get worse."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question3",
                 "title": "Past Failure",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I do not feel like a failure."
                  },
                  {
                   "value": "Item 2",
                   "text": "I have failed more than I should have."
                  },
                  {
                   "value": "Item 3",
                   "text": "As I look back, I see a lot of failures."
                  },
                  {
                   "value": "Item 4",
                   "text": "I feel I am a total failure as a person."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question4",
                 "title": "Loss of Pleasure",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I get as much pleasure as I ever did from the things I enjoy."
                  },
                  {
                   "value": "Item 2",
                   "text": "I don't enjoy things as much as I used to."
                  },
                  {
                   "value": "Item 3",
                   "text": "I get very little pleasure from the things I used to enjoy."
                  },
                  {
                   "value": "Item 4",
                   "text": "I can't get any pleasure from the things I used to enjoy."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question5",
                 "title": "Guilty Feelings",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I don't feel particularly guilty."
                  },
                  {
                   "value": "Item 2",
                   "text": "I feel guilty over many things I have done or should have done."
                  },
                  {
                   "value": "Item 3",
                   "text": "I feel quite guilty most of the time."
                  },
                  {
                   "value": "Item 4",
                   "text": "I feel guilty all of the time."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question6",
                 "title": "Punishment Feelings",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I don't feel I am being punished."
                  },
                  {
                   "value": "Item 2",
                   "text": "I feel I may be punished."
                  },
                  {
                   "value": "Item 3",
                   "text": "I expect to be punished."
                  },
                  {
                   "value": "Item 4",
                   "text": "I feel I am being punished."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question7",
                 "title": "Self-Dislike",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I feel the same about myself as ever."
                  },
                  {
                   "value": "Item 2",
                   "text": "I have lost confidence in myself."
                  },
                  {
                   "value": "Item 3",
                   "text": "I am disappointed in myself."
                  },
                  {
                   "value": "Item 4",
                   "text": "I dislike myself."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question8",
                 "title": "Self-Criticalness",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I don't criticize or blame myself more than usual."
                  },
                  {
                   "value": "Item 2",
                   "text": "I am more critical of myself than I used to be."
                  },
                  {
                   "value": "Item 3",
                   "text": "I criticize myself for all of my faults."
                  },
                  {
                   "value": "Item 4",
                   "text": "I blame myself for everything bad that happens."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question10",
                 "title": "Crying",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I don't cry any more than I used to."
                  },
                  {
                   "value": "Item 2",
                   "text": "I cry more than I used to."
                  },
                  {
                   "value": "Item 3",
                   "text": "I cry over every little thing."
                  },
                  {
                   "value": "Item 4",
                   "text": "I feel like crying, but I can't."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question11",
                 "title": "Agitation",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I am no more restless or wound up than usual."
                  },
                  {
                   "value": "Item 2",
                   "text": "I feel more restless or wound up than usual."
                  },
                  {
                   "value": "Item 3",
                   "text": "I am so restless or agitated that it's hard to stay still."
                  },
                  {
                   "value": "Item 4",
                   "text": "I am so restless or agitated that I have to keep moving or doing something."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question12",
                 "title": "Loss of interest",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I have not lost interest in other people or activities."
                  },
                  {
                   "value": "Item 2",
                   "text": "I am less interested in other people or things than before."
                  },
                  {
                   "value": "Item 3",
                   "text": "I have lost most of my interest in other people or things."
                  },
                  {
                   "value": "Item 4",
                   "text": "It's hard to get interested in anything."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question13",
                 "title": "Indecisiveness",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I make decisions about as well as ever."
                  },
                  {
                   "value": "Item 2",
                   "text": "I find it more difficult to make decisions than usual."
                  },
                  {
                   "value": "Item 3",
                   "text": "I have much greater difficulty in making decisions than I used to."
                  },
                  {
                   "value": "Item 4",
                   "text": "I have trouble making any decisions."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question14",
                 "title": "Worthlessness",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I do not feel I am worthless."
                  },
                  {
                   "value": "Item 2",
                   "text": "I don't consider myself to as worthwhile and useful as I used to."
                  },
                  {
                   "value": "Item 3",
                   "text": "I feel more worthless as compared to other people."
                  },
                  {
                   "value": "Item 4",
                   "text": "I feel utterly worthless."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question15",
                 "title": "Loss of Energy",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I have as much energy as ever."
                  },
                  {
                   "value": "Item 2",
                   "text": "I have less energy than I used to have."
                  },
                  {
                   "value": "Item 3",
                   "text": "I don't have enough energy to do very much."
                  },
                  {
                   "value": "Item 4",
                   "text": "I don't have enough energy to do anything."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question16",
                 "title": "Changes in Sleeping Pattern",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I have not experienced any change in my sleeping pattern"
                  },
                  {
                   "value": "Item 2a",
                   "text": "I sleep somewhat more than usual."
                  },
                  {
                   "value": "Item 2b",
                   "text": "I sleep somewhat less than usual."
                  },
                  {
                   "value": "Item 3a",
                   "text": "I sleep a lot more than usual."
                  },
                  {
                   "value": "Item 3b",
                   "text": "I sleep a lot less than usual."
                  },
                  {
                   "value": "Item 4a",
                   "text": "I sleep most of the day."
                  },
                  {
                   "value": "Item 4b",
                   "text": "I wake up 1-2 hours early and can't go back to sleep."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question17",
                 "title": "Irritability",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I am no more irritable than usual."
                  },
                  {
                   "value": "Item 2",
                   "text": "I am more irritable than usual."
                  },
                  {
                   "value": "Item 3",
                   "text": "I am much more irritable than usual."
                  },
                  {
                   "value": "Item 4",
                   "text": "I am irritable all the time."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question18",
                 "title": "Changes in Appetite",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I have not experienced any change in my appetite"
                  },
                  {
                   "value": "Item 2a",
                   "text": "My appetite is somewhat less than usual."
                  },
                  {
                   "value": "Item 2b",
                   "text": "My appetite is somewhat greater than usual."
                  },
                  {
                   "value": "Item 3a",
                   "text": "My appetite is much less than before."
                  },
                  {
                   "value": "Item 3b",
                   "text": "My appetite is much greater than usual."
                  },
                  {
                   "value": "Item 4a",
                   "text": "I have no appetite at all."
                  },
                  {
                   "value": "Item 4b",
                   "text": "I crave food all the time."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question19",
                 "title": "Concentration Difficulty",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I can concentrate as well as ever."
                  },
                  {
                   "value": "Item 2",
                   "text": "I can't concentrate as well as usual."
                  },
                  {
                   "value": "Item 3",
                   "text": "It's hard to keep my mind on anything for very long."
                  },
                  {
                   "value": "Item 4",
                   "text": "I find I can't concentrate on anything."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question20",
                 "title": "Tiredness or Fatigue",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I am no more tired or fatigued than usual."
                  },
                  {
                   "value": "Item 2",
                   "text": "I get more tired or fatigued more easily than usual."
                  },
                  {
                   "value": "Item 3",
                   "text": "I am too tired or fatigued to do a lot of the things I used to do."
                  },
                  {
                   "value": "Item 4",
                   "text": "I am too tired or fatigued to do most of the things I used to do."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question21",
                 "title": "Loss of Interest in Sex",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "I have not noticed any recent change in my interest in sex."
                  },
                  {
                   "value": "Item 2",
                   "text": "I am less interested in sex than I used to be."
                  },
                  {
                   "value": "Item 3",
                   "text": "I am much less interested in sex now."
                  },
                  {
                   "value": "Item 4",
                   "text": "I have lost interest in sex completely."
                  }
                 ]
                }
               ]
              }
             ]
            }

        window.survey = new Survey.Model(json);


        // Recor the response time or how long they spent on a page
        lastpage = survey.currentPage;
        function timerLoop(elapsed) {
            var page = survey.currentPage; // page variable is the currentPage on the survey
            if (!page) return;
            if (lastpage != page) {
                // set new start date
                start = new Date().getTime(); // sets new start Date object when page has changed.
                lastpage = page // sets the last page to currente page 

            }
            var valueName = "TRQ" + survey.pages.indexOf(page);

            var ms = survey.getValue(valueName); // gets the value of the valuename. e.g: TRQ1

            if (ms == null) ms = 0;
            else ms = elapsed;
            survey.setValue(valueName, ms);
            $('#timeEl').text(elapsed + ' ms');
        }


        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return 'NULL'
        }

        survey.showProgressBar = "bottom";

        survey.goNextPageAutomatic = false
        survey.showNavigationButtons = true;
        survey.showCompletedPage = false;

        // Get Query Variables
        var surveyname = getQueryVariable('survey');

        var expInfo = { 'participant': '' ,'session': '',  'task': surveyname, 'date' : formatDate(), 'study': '', 'id': getQueryVariable('id') };

        // Get info Promize
        const getInfoPromise = new Promise((resolve, reject) => {
            $.ajax({
                type: "POST",
                url: '/getInfo',
                data: { 'id': expInfo.id },
                dataType: 'JSON',
                success: function (data) {
                    resolve(data)
                }
            })
        })
            // Read getINFO 
            .then((values) => {
                console.log(values)
                if (values.subject && values.session && values.study) {
                    expInfo.participant = values.subject
                    expInfo.study = values.study
                    expInfo.session = values.session
                    expInfo.run_id = getQueryVariable('run')
                }

                survey.onComplete.add(function (result) {
                    //result.preventDefault();
                    postSurveyData(result.data, expInfo.session, expInfo.participant);
                });

                $("#surveyElement").Survey({model: survey});
    
                $("#participant").text(expInfo.participant);
                $("#session").text(expInfo.session);
                $("#study").text(expInfo.study);

            })

        function postSurveyData(data, session, mkturkid) {
            console.log('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
            $.ajax({
                type: "POST",
                url: '/save',
                data: {
                    "trials_data": data,
                    "expInfo": expInfo
                },
                dataType: 'JSON',
                statusCode: {
                    200: function() {
                        console.log('sucess saved on backend')
                        console.log('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
                        window.location.replace('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
                    }
                }
            }) 
                
        }

        var start = new Date().getTime(),
            elapsed = '0.0';

        // executes timerCallback every 100 ms
        timerID = window.setInterval(function () {

            var time = new Date().getTime() - start;
            elapsed = Math.floor(time);

            //alert(elapsed);
            //$('#timeEl').text(elapsed + ' ms');

            //displayTime(1);
            timerLoop(elapsed);

        }, 5);
    </script>

</body>

</html>
