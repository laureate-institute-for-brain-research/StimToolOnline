<!DOCTYPE html>
<html lang="en">

<head>
    <style type="text/css">
        @font-face {
            font-family: gotham;
            src: url(/gotham-book-regular.otf);
        }

        * {
            font-family: Helvetica Neue;
        }

        a:link,
        a:visited {
            color: #5e3f99;
        }

        input[type=text]:focus {
            border-color: #f68826;
            box-shadow: 0 0 5px #f68826 !important;
        }

        input[type=email]:focus {
            border-color: #f68826;
            box-shadow: 0 0 5px #f68826 !important;
        }

        span {
            color: white !important;
            fill: white !important;
        }

        .sv-root-modern .sv-container-modern {
            color: white !important;
            fill: white !important;
        }
        .sv-radio__svg {
            border-color: white !important;
        }

        .sv-root-modern .sv-radio--checked .sv-radio__svg  {
            fill: white !important;
        }

        .sv-root-modern input.sv-text, textarea.sv-comment, select.sv-dropdown{
            color: white !important;
        }
        
    </style>
    <title>Surveys</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

    <!-- Latest compiled and minified CSS -->
    <!-- Using Bootsawtch theme: https://bootswatch.com/cyborg/ -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">


    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <link href="https://unpkg.com/survey-knockout@1.8.41/modern.css" type="text/css" rel="stylesheet"/>
    <script src="https://unpkg.com/jquery"></script>
    <script src="https://unpkg.com/survey-jquery@1.8.41/survey.jquery.min.js"></script>

    <script type="text/javascript" src='/js/StimToolLib.js'></script>

</head>

<body>

    <div class="container" style="max-width: 800px;">
        <div class="py-5 text-center">
            <img class="d-block mx-auto mb-4" src="/images/logo_reversed.jpg" alt="" width="180" height="50">
            <!-- <h4>Cultural Survey</h4> -->
          </div>
    </div>

    <div class="container" style="max-width: 800px;">
        <div class="row" >
            <div id="surveyElement" style="max-width: 800px; width: 770px; margin-bottom:40px"></div>
            
            <div id="surveyResult"></div>
        </div>
    </div>

    <div class="jumbotron container" style="margin-bottom:0;max-width: 400px;">
        <table class="table table-hover">
            <tbody>
                <tr>
                  <th scope="row">ID:</th>
                  <td><a id="participant"></a></td>
                </tr>
                <tr>
                    <th scope="row">Session:</th>
                    <td><a id="session"></a></td>
                  </tr>
                  <tr>
                    <th scope="row">Study:</th>
                    <td><a id="study"></a></td>
                  </tr>
              </tbody>
        </table>
        <p style="text-align: center;">&copy; 2021 <a href="http://www.laureateinstitute.org">laureateinstitute.org</a>. All rights reserved.</p>
    </div>

    <script type="text/javascript">

        Survey
            .StylesManager
            .applyTheme("modern");
        // Survey.Survey.cssType = "bootstrap";
        // Survey.defaultBootstrapCss.navigationButton = "btn";
        var json = {
             "title": "Overall Anxiety Severity and Impairment Scale",
             "logoPosition": "right",
             "pages": [
              {
               "name": "page1",
               "elements": [
                {
                 "type": "radiogroup",
                 "name": "question1",
                 "title": "In the past week, how often have you felt anxious?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "No anxiety in past week."
                  },
                  {
                   "value": "Item 2",
                   "text": "Infrequent anxiety. Felt anxious a few times."
                  },
                  {
                   "value": "Item 3",
                   "text": "Occasional anxiety. Felt anxious as much of the time as not. It was hard to relax."
                  },
                  {
                   "value": "Item 4",
                   "text": "Frequent anxiety. Felt anxious most of the time. It was very difficult to relax."
                  },
                  {
                   "value": "Item 5",
                   "text": "Constant anxiety. Felt anxious all of the time and never really relaxed."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question2",
                 "title": "In the past week, when you have felt anxious, how intense or severe was your anxiety?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "Little or None: Anxiety was absent or barely noticeable."
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild: Anxiety was at a low level. It was possible to relax when I tried. Physical symptoms were only slightly uncomfortable."
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate: Anxiety was distressing at times. It was hard to relax or concentrate, but I could do it if I tried. Physical symptoms were uncomfortable."
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe: Anxiety was intense much of the time. It was very difficult to relax or focus on anything else. Physical symptoms were extremely uncomfortable."
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme: Anxiety was overwhelming. It was impossible to relax at all. Physical symptoms were unbearable."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question3",
                 "title": "In the past week, how often did you avoid situations, places, objects, or activities because of anxiety or fear?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None: I do not avoid places, situations, activities, or things because of fear."
                  },
                  {
                   "value": "Item 2",
                   "text": "Infrequent: I avoid something once in a while, but will usually face the situation or confront the object. My lifestyle is not affected."
                  },
                  {
                   "value": "Item 3",
                   "text": "Occasional: I have some fear of certain situations, places, or objects, but it is still manageable. My lifestyle has only changed in minor ways. I always or almost always avoid the things I fear when I'm alone, but can handle them if someone comes with me."
                  },
                  {
                   "value": "Item 4",
                   "text": "Frequent: I have considerable fear and really try to avoid the things that frighten me. I have made significant changes in my lifestyle to avoid the object, situation, activity or place."
                  },
                  {
                   "value": "Item 5",
                   "text": "All the Time: Avoiding objects, situations, activities, or places has taken over my life. My lifestyle has been extensively affected and I no longer do things that I used to enjoy."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question4",
                 "title": "In the past week, how much did your anxiety interfere with your ability to do the things you needed to do at work, at school, or at home?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None: No interference at work/home/school from anxiety."
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild: My anxiety has caused some interference at work/home/school. Things are more difficult, but everything that needs to be done is still getting done."
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate: My anxiety definitely interferes with tasks. Most things are still getting done, but few things are being done as well as in the past."
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe: My anxiety has really changed my ability to get things done. Some tasks are still being done, but many things are not. My performance has definitely suffered."
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme: My anxiety has become incapacitating. I am unable to complete tasks and have had to leave school, have quit or been fired from my job, or have been unable to complete tasks at home and have faced consequences like bill collectors, eviction, etc."
                  }
                 ]
                },
                {
                 "type": "radiogroup",
                 "name": "question5",
                 "title": "In the past week, how much has anxiety interfered with your social life and relationships?",
                 "isRequired": true,
                 "choices": [
                  {
                   "value": "Item 1",
                   "text": "None: My anxiety doesn't affect my relationships."
                  },
                  {
                   "value": "Item 2",
                   "text": "Mild: My anxiety slightly interferes with my relationships. Some of my friendships and other relationships have suffered, but, overall, my social life is fulfilling."
                  },
                  {
                   "value": "Item 3",
                   "text": "Moderate: I have experienced some interference with my social life, but I still have a few close relationships. I don't spend as much time with others as in the past, but I still socialize sometimes."
                  },
                  {
                   "value": "Item 4",
                   "text": "Severe: My friendships and other relationships have suffered a lot because of anxiety. I do not enjoy social activities. I socialize very little."
                  },
                  {
                   "value": "Item 5",
                   "text": "Extreme: My anxiety has completely disrupted my social activities. All of my relationships have suffered or ended. My family life is extremely strained."
                  }
                 ]
                }
               ],
               "description": "The following items ask about anxiety and fear. These symptoms may include panic attacks, situational anxieties, worries, flashbacks, hypervigilance or startle. Include ALL of your anxiety symptoms when answering these questions. For each item, select the answer that best describes your experience over the past week."
              }
             ]
            }

        window.survey = new Survey.Model(json);


        // Recor the response time or how long they spent on a page
        lastpage = survey.currentPage;
        function timerLoop(elapsed) {
            var page = survey.currentPage; // page variable is the currentPage on the survey
            if (!page) return;
            if (lastpage != page) {
                // set new start date
                start = new Date().getTime(); // sets new start Date object when page has changed.
                lastpage = page // sets the last page to currente page 

            }
            var valueName = "TRQ" + survey.pages.indexOf(page);

            var ms = survey.getValue(valueName); // gets the value of the valuename. e.g: TRQ1

            if (ms == null) ms = 0;
            else ms = elapsed;
            survey.setValue(valueName, ms);
            $('#timeEl').text(elapsed + ' ms');
        }


        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return 'NULL'
        }

        survey.showProgressBar = "bottom";

        survey.goNextPageAutomatic = false
        survey.showNavigationButtons = true;
        survey.showCompletedPage = false;

        // Get Query Variables
        var surveyname = getQueryVariable('survey');

        var expInfo = { 'participant': '' ,'session': '',  'task': surveyname, 'date' : formatDate(), 'study': '', 'id': getQueryVariable('id') };

        // Get info Promize
        const getInfoPromise = new Promise((resolve, reject) => {
            $.ajax({
                type: "POST",
                url: '/getInfo',
                data: { 'id': expInfo.id },
                dataType: 'JSON',
                success: function (data) {
                    resolve(data)
                }
            })
        })
            // Read getINFO 
            .then((values) => {
                console.log(values)
                if (values.subject && values.session && values.study) {
                    expInfo.participant = values.subject
                    expInfo.study = values.study
                    expInfo.session = values.session
                    expInfo.run_id = getQueryVariable('run')
                }

                survey.onComplete.add(function (result) {
                    //result.preventDefault();
                    postSurveyData(result.data, expInfo.session, expInfo.participant);
                });

                $("#surveyElement").Survey({model: survey});
    
                $("#participant").text(expInfo.participant);
                $("#session").text(expInfo.session);
                $("#study").text(expInfo.study);

            })

        function postSurveyData(data, session, mkturkid) {
            console.log('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
            $.ajax({
                type: "POST",
                url: '/save',
                data: {
                    "trials_data": data,
                    "expInfo": expInfo
                },
                dataType: 'JSON',
                statusCode: {
                    200: function() {
                        console.log('sucess saved on backend')
                        console.log('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
                        window.location.replace('/link?id=' + expInfo.id  + '&index=' + (parseInt(getQueryVariable('index')) + 1))
                    }
                }
            }) 
                
        }

        var start = new Date().getTime(),
            elapsed = '0.0';

        // executes timerCallback every 100 ms
        timerID = window.setInterval(function () {

            var time = new Date().getTime() - start;
            elapsed = Math.floor(time);

            //alert(elapsed);
            //$('#timeEl').text(elapsed + ' ms');

            //displayTime(1);
            timerLoop(elapsed);

        }, 5);
    </script>

</body>

</html>
